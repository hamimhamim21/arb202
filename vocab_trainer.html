<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Trainer | ARB202</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <script src="vocab_data.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
        }

        .arabic { font-family: 'Amiri', serif; direction: rtl; }

        /* Header */
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p { opacity: 0.7; font-size: 14px; }

        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #e94560 0%, #ff6b6b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
            z-index: 1001;
            transition: all 0.3s;
        }

        .home-btn:hover { transform: scale(1.1); }
        .home-btn svg { width: 22px; height: 22px; fill: white; }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.points { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .stat-icon.streak { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-icon.mastered { background: linear-gradient(135deg, #2ecc71, #27ae60); }

        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.7; }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Screen Navigation */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Module Selection Screen */
        .section-title {
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 30px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 2px;
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .module-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .module-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .module-card.selected {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }

        .module-number {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .module-name {
            font-size: 14px;
            opacity: 0.8;
            margin: 5px 0;
        }

        .module-arabic {
            font-family: 'Amiri', serif;
            font-size: 18px;
            direction: rtl;
            opacity: 0.9;
        }

        .module-progress {
            margin-top: 10px;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .module-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .module-word-count {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 5px;
        }

        /* Direction Toggle */
        .direction-section {
            margin-bottom: 30px;
        }

        .direction-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .direction-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }

        .direction-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .direction-btn.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .direction-btn .arrow { font-size: 20px; }

        /* Mode Selection */
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid transparent;
            border-radius: 20px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .mode-card.speed::before { background: linear-gradient(90deg, #f1c40f, #e67e22); }
        .mode-card.builder::before { background: linear-gradient(90deg, #3498db, #2980b9); }
        .mode-card.context::before { background: linear-gradient(90deg, #9b59b6, #8e44ad); }
        .mode-card.matrix::before { background: linear-gradient(90deg, #e74c3c, #c0392b); }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .mode-card.selected {
            border-color: #00d9ff;
        }

        .mode-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .mode-card.speed .mode-icon { background: linear-gradient(135deg, #f1c40f, #e67e22); }
        .mode-card.builder .mode-icon { background: linear-gradient(135deg, #3498db, #2980b9); }
        .mode-card.context .mode-icon { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .mode-card.matrix .mode-icon { background: linear-gradient(135deg, #e74c3c, #c0392b); }

        .mode-title { font-size: 20px; font-weight: bold; margin-bottom: 8px; }
        .mode-desc { font-size: 14px; opacity: 0.7; line-height: 1.5; }
        .mode-tags { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; }

        .mode-tag {
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            opacity: 0.8;
        }

        /* Start Button */
        .start-section {
            text-align: center;
            padding: 20px;
        }

        .start-btn {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            border-radius: 15px;
            padding: 18px 50px;
            font-size: 20px;
            font-weight: bold;
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .selection-summary {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.7;
        }

        /* Training Screen */
        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
        }

        .training-progress {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-text { font-size: 18px; }

        .progress-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            transition: width 0.3s ease;
        }

        .training-stats {
            display: flex;
            gap: 20px;
        }

        .training-stat {
            text-align: center;
        }

        .training-stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .training-stat-value.correct { color: #2ecc71; }
        .training-stat-value.wrong { color: #e74c3c; }

        .training-stat-label {
            font-size: 12px;
            opacity: 0.6;
        }

        .quit-btn {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quit-btn:hover {
            background: rgba(231, 76, 60, 0.3);
        }

        /* Training Area */
        .training-area {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 40px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Speed Challenge Mode */
        .speed-timer {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .timer-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f1c40f, #e74c3c);
            transition: width 0.1s linear;
        }

        .word-display {
            text-align: center;
            margin-bottom: 30px;
        }

        .word-display .arabic-word {
            font-family: 'Amiri', serif;
            font-size: 64px;
            direction: rtl;
            margin-bottom: 10px;
            color: #fff;
        }

        .word-display .english-word {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .word-display .hint {
            font-size: 16px;
            opacity: 0.6;
            font-style: italic;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .option-btn {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            font-size: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .option-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
            transform: scale(1.02);
        }

        .option-btn.correct {
            background: rgba(46, 204, 113, 0.3);
            border-color: #2ecc71;
        }

        .option-btn.wrong {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
        }

        .option-btn.arabic {
            font-family: 'Amiri', serif;
            font-size: 28px;
            direction: rtl;
        }

        .option-btn:disabled { cursor: not-allowed; }

        /* Word Builder Mode */
        .builder-input-area {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .builder-input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            font-size: 28px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .builder-input:focus {
            outline: none;
            border-color: #00d9ff;
            background: rgba(255,255,255,0.15);
        }

        .builder-input.arabic {
            font-family: 'Amiri', serif;
            direction: rtl;
        }

        .builder-input.correct {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.2);
        }

        .builder-input.wrong {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .hint-btn {
            background: rgba(241, 196, 15, 0.2);
            border: 1px solid #f1c40f;
            color: #f1c40f;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.3s;
        }

        .hint-btn:hover { background: rgba(241, 196, 15, 0.3); }

        .submit-btn {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            color: #1a1a2e;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: scale(1.05);
        }

        .hint-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(241, 196, 15, 0.1);
            border-radius: 10px;
            color: #f1c40f;
        }

        .correct-answer-display {
            margin-top: 20px;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 10px;
        }

        .correct-answer-display .label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .correct-answer-display .answer {
            font-size: 24px;
        }

        .correct-answer-display .answer.arabic {
            font-family: 'Amiri', serif;
            direction: rtl;
        }

        /* Memory Matrix Mode */
        .matrix-grid {
            display: grid;
            gap: 12px;
            width: 100%;
            max-width: 600px;
        }

        .matrix-grid.size-3x4 { grid-template-columns: repeat(4, 1fr); }
        .matrix-grid.size-4x4 { grid-template-columns: repeat(4, 1fr); }

        .matrix-card {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            padding: 10px;
            text-align: center;
        }

        .matrix-card:hover:not(.matched):not(.flipped) {
            background: rgba(255,255,255,0.1);
            transform: scale(1.02);
        }

        .matrix-card.flipped {
            background: rgba(0, 217, 255, 0.2);
            border-color: #00d9ff;
        }

        .matrix-card.matched {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            cursor: default;
        }

        .matrix-card.wrong {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
        }

        .matrix-card .card-content {
            display: none;
        }

        .matrix-card.flipped .card-content,
        .matrix-card.matched .card-content {
            display: block;
        }

        .matrix-card.flipped .card-back,
        .matrix-card.matched .card-back {
            display: none;
        }

        .matrix-card .card-back { opacity: 0.5; }

        .matrix-card.arabic .card-content {
            font-family: 'Amiri', serif;
            font-size: 22px;
            direction: rtl;
        }

        /* Context Detective Mode */
        .context-sentence {
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
            line-height: 2;
        }

        .context-sentence.arabic {
            font-family: 'Amiri', serif;
            direction: rtl;
        }

        .context-blank {
            display: inline-block;
            min-width: 150px;
            border-bottom: 3px solid #00d9ff;
            margin: 0 10px;
            padding: 0 10px;
        }

        .context-translation {
            font-size: 18px;
            opacity: 0.7;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Results Screen */
        .results-container {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .results-score {
            font-size: 72px;
            font-weight: bold;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .results-label {
            font-size: 24px;
            opacity: 0.7;
            margin-bottom: 30px;
        }

        .results-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .results-stat {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
        }

        .results-stat-value {
            font-size: 32px;
            font-weight: bold;
        }

        .results-stat-label {
            font-size: 14px;
            opacity: 0.6;
            margin-top: 5px;
        }

        .results-breakdown {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: left;
        }

        .results-breakdown h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .breakdown-item:last-child { border-bottom: none; }

        .breakdown-word {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .breakdown-word .arabic {
            font-family: 'Amiri', serif;
            direction: rtl;
        }

        .breakdown-status {
            font-size: 20px;
        }

        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .results-btn {
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .results-btn.primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border: none;
            color: #1a1a2e;
        }

        .results-btn.secondary {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
        }

        .results-btn:hover {
            transform: scale(1.05);
        }

        /* Achievements */
        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #f1c40f;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 2000;
            transition: transform 0.3s ease;
        }

        .achievement-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .achievement-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .achievement-title {
            font-size: 24px;
            color: #f1c40f;
            margin-bottom: 10px;
        }

        .achievement-desc {
            opacity: 0.7;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1999;
            display: none;
        }

        .overlay.show { display: block; }

        /* Next Word Animation */
        .slide-out {
            animation: slideOut 0.3s ease forwards;
        }

        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideOut {
            to {
                opacity: 0;
                transform: translateX(-50px);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-bar { gap: 15px; }
            .stat-value { font-size: 18px; }
            .module-grid { grid-template-columns: repeat(2, 1fr); }
            .mode-grid { grid-template-columns: 1fr; }
            .options-grid { grid-template-columns: 1fr; }
            .word-display .arabic-word { font-size: 42px; }
            .word-display .english-word { font-size: 28px; }
            .training-header { flex-direction: column; gap: 15px; }
            .results-stats { grid-template-columns: 1fr; }
            .results-actions { flex-direction: column; }
        }
    </style>
</head>
<body>

<a href="index.html" class="home-btn" title="Back to Home">
    <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
</a>

<!-- Header -->
<header class="header">
    <h1>Vocabulary Trainer</h1>
    <p>Master Arabic vocabulary with smart, adaptive learning</p>
</header>

<!-- Stats Bar -->
<div class="stats-bar">
    <div class="stat-item">
        <div class="stat-icon points">‚ö°</div>
        <div>
            <div class="stat-value" id="totalPoints">0</div>
            <div class="stat-label">Points</div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon streak">üî•</div>
        <div>
            <div class="stat-value" id="currentStreak">0</div>
            <div class="stat-label">Day Streak</div>
        </div>
    </div>
    <div class="stat-item">
        <div class="stat-icon mastered">‚úì</div>
        <div>
            <div class="stat-value" id="masteredWords">0</div>
            <div class="stat-label">Mastered</div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Selection Screen -->
    <div class="screen active" id="selectionScreen">
        <!-- Module Selection -->
        <h2 class="section-title">Select Module(s)</h2>
        <div class="module-grid" id="moduleGrid"></div>

        <!-- Direction Selection -->
        <div class="direction-section">
            <h2 class="section-title">Learning Direction</h2>
            <div class="direction-options">
                <button class="direction-btn selected" data-direction="ar-en">
                    <span class="arabic">ÿπÿ±ÿ®Ÿä</span>
                    <span class="arrow">‚Üí</span>
                    <span>English</span>
                </button>
                <button class="direction-btn" data-direction="en-ar">
                    <span>English</span>
                    <span class="arrow">‚Üí</span>
                    <span class="arabic">ÿπÿ±ÿ®Ÿä</span>
                </button>
                <button class="direction-btn" data-direction="mixed">
                    <span>Mixed</span>
                    <span class="arrow">‚áÑ</span>
                    <span>Random</span>
                </button>
            </div>
        </div>

        <!-- Mode Selection -->
        <h2 class="section-title">Choose Learning Mode</h2>
        <div class="mode-grid">
            <div class="mode-card speed selected" data-mode="speed">
                <div class="mode-icon">‚ö°</div>
                <div class="mode-title">Speed Challenge</div>
                <div class="mode-desc">Race against the clock! Choose the correct translation from 4 options before time runs out.</div>
                <div class="mode-tags">
                    <span class="mode-tag">Timed</span>
                    <span class="mode-tag">Multiple Choice</span>
                    <span class="mode-tag">Streak Bonuses</span>
                </div>
            </div>
            <div class="mode-card builder" data-mode="builder">
                <div class="mode-icon">‚úçÔ∏è</div>
                <div class="mode-title">Word Builder</div>
                <div class="mode-desc">Type the translation yourself. Use hints if stuck. Perfect for active recall practice.</div>
                <div class="mode-tags">
                    <span class="mode-tag">Typing</span>
                    <span class="mode-tag">Hints Available</span>
                    <span class="mode-tag">Deep Learning</span>
                </div>
            </div>
            <div class="mode-card matrix" data-mode="matrix">
                <div class="mode-icon">üéØ</div>
                <div class="mode-title">Memory Matrix</div>
                <div class="mode-desc">Match Arabic words with their English meanings in a memory game. Find all pairs!</div>
                <div class="mode-tags">
                    <span class="mode-tag">Matching</span>
                    <span class="mode-tag">Visual</span>
                    <span class="mode-tag">Memory</span>
                </div>
            </div>
            <div class="mode-card context" data-mode="context">
                <div class="mode-icon">üìñ</div>
                <div class="mode-title">Context Detective</div>
                <div class="mode-desc">Fill in the blanks in sentences. Learn words in real context for better retention.</div>
                <div class="mode-tags">
                    <span class="mode-tag">Sentences</span>
                    <span class="mode-tag">Context</span>
                    <span class="mode-tag">Practical</span>
                </div>
            </div>
        </div>

        <!-- Start Button -->
        <div class="start-section">
            <button class="start-btn" id="startBtn" disabled>Start Training</button>
            <div class="selection-summary" id="selectionSummary">
                Select at least one module to begin
            </div>
        </div>
    </div>

    <!-- Training Screen -->
    <div class="screen" id="trainingScreen">
        <div class="training-header">
            <div class="training-progress">
                <span class="progress-text"><span id="currentWord">0</span> / <span id="totalWords">0</span></span>
                <div class="progress-bar">
                    <div class="progress-fill" id="trainingProgressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="training-stats">
                <div class="training-stat">
                    <div class="training-stat-value correct" id="correctCount">0</div>
                    <div class="training-stat-label">Correct</div>
                </div>
                <div class="training-stat">
                    <div class="training-stat-value wrong" id="wrongCount">0</div>
                    <div class="training-stat-label">Wrong</div>
                </div>
            </div>
            <button class="quit-btn" id="quitBtn">Quit</button>
        </div>

        <div class="training-area" id="trainingArea">
            <!-- Training content loaded dynamically -->
        </div>
    </div>

    <!-- Results Screen -->
    <div class="screen" id="resultsScreen">
        <div class="results-container">
            <div class="results-score" id="resultsScore">0%</div>
            <div class="results-label" id="resultsLabel">Great job!</div>

            <div class="results-stats">
                <div class="results-stat">
                    <div class="results-stat-value" id="resultsCorrect">0</div>
                    <div class="results-stat-label">Correct</div>
                </div>
                <div class="results-stat">
                    <div class="results-stat-value" id="resultsWrong">0</div>
                    <div class="results-stat-label">Wrong</div>
                </div>
                <div class="results-stat">
                    <div class="results-stat-value" id="resultsPoints">+0</div>
                    <div class="results-stat-label">Points Earned</div>
                </div>
            </div>

            <div class="results-breakdown" id="resultsBreakdown">
                <h3>Word Breakdown</h3>
                <!-- Breakdown items loaded dynamically -->
            </div>

            <div class="results-actions">
                <button class="results-btn primary" id="practiceAgainBtn">Practice Again</button>
                <button class="results-btn secondary" id="reviewMissedBtn">Review Missed</button>
                <button class="results-btn secondary" id="backToMenuBtn">Back to Menu</button>
            </div>
        </div>
    </div>
</div>

<!-- Achievement Popup -->
<div class="overlay" id="overlay"></div>
<div class="achievement-popup" id="achievementPopup">
    <div class="achievement-icon" id="achievementIcon">üèÜ</div>
    <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
    <div class="achievement-desc" id="achievementDesc">You completed your first training session!</div>
</div>

<script>
// ============================================
// STATE MANAGEMENT
// ============================================
const state = {
    selectedModules: [],
    selectedDirection: 'ar-en',
    selectedMode: 'speed',
    currentSession: {
        words: [],
        currentIndex: 0,
        correct: 0,
        wrong: 0,
        answers: [],
        points: 0,
        startTime: null
    },
    progress: {
        totalPoints: 0,
        streak: 0,
        lastPractice: null,
        masteredWords: [],
        moduleProgress: {}
    }
};

// Load progress from localStorage
function loadProgress() {
    const saved = localStorage.getItem('vocab_trainer_progress');
    if (saved) {
        const parsed = JSON.parse(saved);
        state.progress = { ...state.progress, ...parsed };
        updateStatsDisplay();
    }
}

// Save progress to localStorage
function saveProgress() {
    localStorage.setItem('vocab_trainer_progress', JSON.stringify(state.progress));
}

// Update stats display
function updateStatsDisplay() {
    document.getElementById('totalPoints').textContent = state.progress.totalPoints;
    document.getElementById('currentStreak').textContent = state.progress.streak;
    document.getElementById('masteredWords').textContent = state.progress.masteredWords.length;
}

// ============================================
// INITIALIZATION
// ============================================
function init() {
    loadProgress();
    renderModuleGrid();
    setupEventListeners();
    checkDailyStreak();
}

function renderModuleGrid() {
    const grid = document.getElementById('moduleGrid');
    grid.innerHTML = '';

    Object.keys(ARB202_VOCABULARY).forEach(moduleKey => {
        const module = ARB202_VOCABULARY[moduleKey];
        const moduleNum = moduleKey.replace('module', '');
        const progress = state.progress.moduleProgress[moduleKey] || 0;
        const wordCount = module.words.length;

        const card = document.createElement('div');
        card.className = 'module-card';
        card.dataset.module = moduleKey;
        card.innerHTML = `
            <div class="module-number">${moduleNum}</div>
            <div class="module-name">${module.name.topic}</div>
            <div class="module-arabic">${module.name.arabic}</div>
            <div class="module-progress">
                <div class="module-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="module-word-count">${wordCount} words ‚Ä¢ ${progress}% mastered</div>
        `;

        card.addEventListener('click', () => toggleModuleSelection(card, moduleKey));
        grid.appendChild(card);
    });
}

function setupEventListeners() {
    // Direction buttons
    document.querySelectorAll('.direction-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.selectedDirection = btn.dataset.direction;
        });
    });

    // Mode cards
    document.querySelectorAll('.mode-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            state.selectedMode = card.dataset.mode;
        });
    });

    // Start button
    document.getElementById('startBtn').addEventListener('click', startTraining);

    // Quit button
    document.getElementById('quitBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to quit? Your progress will be saved.')) {
            showResults();
        }
    });

    // Results buttons
    document.getElementById('practiceAgainBtn').addEventListener('click', () => {
        startTraining();
    });

    document.getElementById('reviewMissedBtn').addEventListener('click', () => {
        const missedWords = state.currentSession.answers
            .filter(a => !a.correct)
            .map(a => a.word);
        if (missedWords.length > 0) {
            state.currentSession.words = missedWords;
            state.currentSession.currentIndex = 0;
            state.currentSession.correct = 0;
            state.currentSession.wrong = 0;
            state.currentSession.answers = [];
            showScreen('trainingScreen');
            runTrainingMode();
        } else {
            alert('No missed words to review!');
        }
    });

    document.getElementById('backToMenuBtn').addEventListener('click', () => {
        showScreen('selectionScreen');
    });

    // Overlay click to close achievement
    document.getElementById('overlay').addEventListener('click', closeAchievement);
}

function toggleModuleSelection(card, moduleKey) {
    card.classList.toggle('selected');

    const index = state.selectedModules.indexOf(moduleKey);
    if (index > -1) {
        state.selectedModules.splice(index, 1);
    } else {
        state.selectedModules.push(moduleKey);
    }

    updateSelectionSummary();
}

function updateSelectionSummary() {
    const summary = document.getElementById('selectionSummary');
    const btn = document.getElementById('startBtn');

    if (state.selectedModules.length === 0) {
        summary.textContent = 'Select at least one module to begin';
        btn.disabled = true;
    } else {
        const wordCount = state.selectedModules.reduce((total, key) => {
            return total + ARB202_VOCABULARY[key].words.length;
        }, 0);
        summary.textContent = `${state.selectedModules.length} module(s) selected ‚Ä¢ ${wordCount} words available`;
        btn.disabled = false;
    }
}

function checkDailyStreak() {
    const today = new Date().toDateString();
    const lastPractice = state.progress.lastPractice;

    if (lastPractice) {
        const lastDate = new Date(lastPractice);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        if (lastDate.toDateString() !== today && lastDate.toDateString() !== yesterday.toDateString()) {
            state.progress.streak = 0;
            saveProgress();
        }
    }
}

// ============================================
// TRAINING LOGIC
// ============================================
function startTraining() {
    // Gather words from selected modules
    let allWords = [];
    state.selectedModules.forEach(moduleKey => {
        const moduleWords = ARB202_VOCABULARY[moduleKey].words.map(w => ({
            ...w,
            module: moduleKey
        }));
        allWords = allWords.concat(moduleWords);
    });

    // Shuffle and limit to 10 words
    shuffleArray(allWords);
    const sessionWords = allWords.slice(0, 10);

    // Initialize session
    state.currentSession = {
        words: sessionWords,
        currentIndex: 0,
        correct: 0,
        wrong: 0,
        answers: [],
        points: 0,
        startTime: Date.now()
    };

    // Update UI
    document.getElementById('totalWords').textContent = sessionWords.length;
    document.getElementById('currentWord').textContent = '1';
    document.getElementById('correctCount').textContent = '0';
    document.getElementById('wrongCount').textContent = '0';
    document.getElementById('trainingProgressFill').style.width = '0%';

    showScreen('trainingScreen');
    runTrainingMode();
}

function runTrainingMode() {
    const mode = state.selectedMode;

    switch (mode) {
        case 'speed':
            runSpeedChallenge();
            break;
        case 'builder':
            runWordBuilder();
            break;
        case 'matrix':
            runMemoryMatrix();
            break;
        case 'context':
            runContextDetective();
            break;
    }
}

// ============================================
// SPEED CHALLENGE MODE
// ============================================
let speedTimer = null;
let timeLeft = 0;

function runSpeedChallenge() {
    const session = state.currentSession;
    if (session.currentIndex >= session.words.length) {
        showResults();
        return;
    }

    const word = session.words[session.currentIndex];
    const direction = getDirection();
    const isArabicQuestion = direction === 'ar-en';

    // Generate options
    const allWords = getAllWords();
    const wrongOptions = allWords
        .filter(w => w.id !== word.id)
        .sort(() => Math.random() - 0.5)
        .slice(0, 3);

    const options = [word, ...wrongOptions].sort(() => Math.random() - 0.5);

    const trainingArea = document.getElementById('trainingArea');
    trainingArea.innerHTML = `
        <div class="speed-timer">
            <div class="timer-bar">
                <div class="timer-fill" id="timerFill" style="width: 100%"></div>
            </div>
        </div>
        <div class="word-display">
            ${isArabicQuestion
                ? `<div class="arabic-word">${word.arabic}</div>`
                : `<div class="english-word">${word.english}</div>`
            }
            <div class="hint">${word.transliteration}</div>
        </div>
        <div class="options-grid">
            ${options.map((opt, i) => `
                <button class="option-btn ${isArabicQuestion ? '' : 'arabic'}"
                        data-correct="${opt.id === word.id}"
                        data-word-id="${opt.id}">
                    ${isArabicQuestion ? opt.english : opt.arabic}
                </button>
            `).join('')}
        </div>
    `;

    // Setup click handlers
    trainingArea.querySelectorAll('.option-btn').forEach(btn => {
        btn.addEventListener('click', () => handleSpeedAnswer(btn, word));
    });

    // Start timer
    startSpeedTimer();
}

function startSpeedTimer() {
    timeLeft = 100;
    const timerFill = document.getElementById('timerFill');

    clearInterval(speedTimer);
    speedTimer = setInterval(() => {
        timeLeft -= 2;
        timerFill.style.width = timeLeft + '%';

        if (timeLeft <= 0) {
            clearInterval(speedTimer);
            handleTimeOut();
        }
    }, 100);
}

function handleSpeedAnswer(btn, word) {
    clearInterval(speedTimer);

    const isCorrect = btn.dataset.correct === 'true';
    const session = state.currentSession;

    // Disable all buttons
    document.querySelectorAll('.option-btn').forEach(b => {
        b.disabled = true;
        if (b.dataset.correct === 'true') {
            b.classList.add('correct');
        }
    });

    if (isCorrect) {
        btn.classList.add('correct');
        session.correct++;
        const bonus = Math.floor(timeLeft / 10);
        session.points += 10 + bonus;
    } else {
        btn.classList.add('wrong');
        session.wrong++;
    }

    session.answers.push({
        word: word,
        correct: isCorrect,
        timeLeft: timeLeft
    });

    updateTrainingProgress();

    setTimeout(() => {
        session.currentIndex++;
        runSpeedChallenge();
    }, 1000);
}

function handleTimeOut() {
    const session = state.currentSession;
    const word = session.words[session.currentIndex];

    document.querySelectorAll('.option-btn').forEach(b => {
        b.disabled = true;
        if (b.dataset.correct === 'true') {
            b.classList.add('correct');
        }
    });

    session.wrong++;
    session.answers.push({
        word: word,
        correct: false,
        timeLeft: 0
    });

    updateTrainingProgress();

    setTimeout(() => {
        session.currentIndex++;
        runSpeedChallenge();
    }, 1500);
}

// ============================================
// WORD BUILDER MODE
// ============================================
let hintsUsed = 0;

function runWordBuilder() {
    const session = state.currentSession;
    if (session.currentIndex >= session.words.length) {
        showResults();
        return;
    }

    const word = session.words[session.currentIndex];
    const direction = getDirection();
    const isArabicQuestion = direction === 'ar-en';

    hintsUsed = 0;

    const trainingArea = document.getElementById('trainingArea');
    trainingArea.innerHTML = `
        <div class="word-display">
            ${isArabicQuestion
                ? `<div class="arabic-word">${word.arabic}</div>`
                : `<div class="english-word">${word.english}</div>`
            }
            <div class="hint">Type the ${isArabicQuestion ? 'English' : 'Arabic'} translation</div>
        </div>
        <div class="builder-input-area">
            <input type="text" class="builder-input ${isArabicQuestion ? '' : 'arabic'}"
                   id="builderInput" placeholder="Type your answer..." autocomplete="off">
            <div style="margin-top: 20px;">
                <button class="hint-btn" id="hintBtn">üí° Hint</button>
                <button class="submit-btn" id="submitBtn">Submit</button>
            </div>
            <div class="hint-display" id="hintDisplay" style="display: none;"></div>
            <div class="correct-answer-display" id="correctAnswerDisplay" style="display: none;">
                <div class="label">Correct answer:</div>
                <div class="answer ${isArabicQuestion ? '' : 'arabic'}" id="correctAnswer"></div>
            </div>
        </div>
    `;

    const input = document.getElementById('builderInput');
    const hintBtn = document.getElementById('hintBtn');
    const submitBtn = document.getElementById('submitBtn');

    input.focus();

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleBuilderSubmit(word, isArabicQuestion);
        }
    });

    hintBtn.addEventListener('click', () => showBuilderHint(word, isArabicQuestion));
    submitBtn.addEventListener('click', () => handleBuilderSubmit(word, isArabicQuestion));
}

function showBuilderHint(word, isArabicQuestion) {
    hintsUsed++;
    const hintDisplay = document.getElementById('hintDisplay');
    const answer = isArabicQuestion ? word.english : word.arabic;

    if (hintsUsed === 1) {
        hintDisplay.textContent = `First letter: ${answer[0]}`;
    } else if (hintsUsed === 2) {
        hintDisplay.textContent = `Starts with: ${answer.substring(0, 3)}...`;
    } else {
        hintDisplay.textContent = `Answer: ${answer}`;
    }

    hintDisplay.style.display = 'block';
}

function handleBuilderSubmit(word, isArabicQuestion) {
    const input = document.getElementById('builderInput');
    const userAnswer = input.value.trim().toLowerCase();
    const correctAnswer = isArabicQuestion ? word.english : word.arabic;
    const correctLower = correctAnswer.toLowerCase();

    // Check for close match (allow minor typos)
    const isCorrect = userAnswer === correctLower ||
                      levenshteinDistance(userAnswer, correctLower) <= 2;

    const session = state.currentSession;

    input.disabled = true;
    document.getElementById('hintBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;

    if (isCorrect) {
        input.classList.add('correct');
        session.correct++;
        const hintPenalty = hintsUsed * 3;
        session.points += Math.max(5, 15 - hintPenalty);
    } else {
        input.classList.add('wrong');
        session.wrong++;
        document.getElementById('correctAnswer').textContent = correctAnswer;
        document.getElementById('correctAnswerDisplay').style.display = 'block';
    }

    session.answers.push({
        word: word,
        correct: isCorrect,
        userAnswer: input.value
    });

    updateTrainingProgress();

    setTimeout(() => {
        session.currentIndex++;
        runWordBuilder();
    }, 1500);
}

// ============================================
// MEMORY MATRIX MODE
// ============================================
let matrixState = {
    cards: [],
    flipped: [],
    matched: 0,
    moves: 0
};

function runMemoryMatrix() {
    const session = state.currentSession;
    const words = session.words.slice(0, 6); // Use 6 pairs for 3x4 grid

    matrixState = {
        cards: [],
        flipped: [],
        matched: 0,
        moves: 0
    };

    // Create pairs
    words.forEach((word, i) => {
        matrixState.cards.push({
            id: i * 2,
            pairId: i,
            type: 'arabic',
            content: word.arabic,
            word: word
        });
        matrixState.cards.push({
            id: i * 2 + 1,
            pairId: i,
            type: 'english',
            content: word.english,
            word: word
        });
    });

    // Shuffle
    shuffleArray(matrixState.cards);

    const trainingArea = document.getElementById('trainingArea');
    trainingArea.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="margin-bottom: 10px;">Match Arabic words with their English translations</h3>
            <p style="opacity: 0.7;">Moves: <span id="matrixMoves">0</span> | Pairs: <span id="matrixPairs">0</span>/${words.length}</p>
        </div>
        <div class="matrix-grid size-3x4" id="matrixGrid">
            ${matrixState.cards.map(card => `
                <div class="matrix-card ${card.type === 'arabic' ? 'arabic' : ''}"
                     data-id="${card.id}" data-pair="${card.pairId}">
                    <div class="card-back">?</div>
                    <div class="card-content">${card.content}</div>
                </div>
            `).join('')}
        </div>
    `;

    // Setup click handlers
    document.querySelectorAll('.matrix-card').forEach(card => {
        card.addEventListener('click', () => handleMatrixClick(card));
    });
}

function handleMatrixClick(cardEl) {
    const cardId = parseInt(cardEl.dataset.id);
    const card = matrixState.cards.find(c => c.id === cardId);

    if (cardEl.classList.contains('flipped') ||
        cardEl.classList.contains('matched') ||
        matrixState.flipped.length >= 2) {
        return;
    }

    cardEl.classList.add('flipped');
    matrixState.flipped.push({ el: cardEl, card: card });

    if (matrixState.flipped.length === 2) {
        matrixState.moves++;
        document.getElementById('matrixMoves').textContent = matrixState.moves;

        const [first, second] = matrixState.flipped;

        if (first.card.pairId === second.card.pairId && first.card.type !== second.card.type) {
            // Match!
            setTimeout(() => {
                first.el.classList.add('matched');
                second.el.classList.add('matched');
                matrixState.matched++;
                document.getElementById('matrixPairs').textContent = matrixState.matched;
                matrixState.flipped = [];

                // Record as correct
                state.currentSession.answers.push({
                    word: first.card.word,
                    correct: true
                });
                state.currentSession.correct++;
                state.currentSession.points += 10;

                updateTrainingProgress();

                if (matrixState.matched === matrixState.cards.length / 2) {
                    setTimeout(() => showResults(), 500);
                }
            }, 300);
        } else {
            // No match
            setTimeout(() => {
                first.el.classList.add('wrong');
                second.el.classList.add('wrong');
                setTimeout(() => {
                    first.el.classList.remove('flipped', 'wrong');
                    second.el.classList.remove('flipped', 'wrong');
                    matrixState.flipped = [];
                }, 500);
            }, 500);
        }
    }
}

// ============================================
// CONTEXT DETECTIVE MODE
// ============================================
function runContextDetective() {
    const session = state.currentSession;
    if (session.currentIndex >= session.words.length) {
        showResults();
        return;
    }

    const word = session.words[session.currentIndex];

    // Check if we have a context sentence for this word
    let contextData = CONTEXT_SENTENCES[word.arabic];

    if (!contextData || contextData.length === 0) {
        // Generate a simple context if none exists
        contextData = [{
            sentence: `ÿ£ŸéŸÜŸéÿß ÿ£Ÿèÿ≠Ÿêÿ®ŸèŸë _____ ŸÉŸéÿ´ŸêŸäÿ±Ÿãÿß`,
            translation: `I like _____ very much`,
            answer: word.arabic,
            hint: word.english
        }];
    }

    const context = contextData[0];

    const trainingArea = document.getElementById('trainingArea');
    trainingArea.innerHTML = `
        <div class="word-display" style="margin-bottom: 30px;">
            <div style="font-size: 20px; opacity: 0.7; margin-bottom: 10px;">Fill in the blank with:</div>
            <div class="english-word">${word.english}</div>
            <div class="hint">${word.transliteration}</div>
        </div>
        <div class="context-sentence arabic">
            ${context.sentence.replace('_____', '<span class="context-blank" id="contextBlank"></span>')}
        </div>
        <div class="context-translation">${context.translation}</div>
        <div class="builder-input-area">
            <input type="text" class="builder-input arabic" id="contextInput"
                   placeholder="ÿßŸÉÿ™ÿ® ÿßŸÑŸÉŸÑŸÖÿ©..." autocomplete="off" dir="rtl">
            <div style="margin-top: 20px;">
                <button class="hint-btn" id="contextHintBtn">üí° Show Word</button>
                <button class="submit-btn" id="contextSubmitBtn">Submit</button>
            </div>
        </div>
    `;

    const input = document.getElementById('contextInput');
    input.focus();

    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleContextSubmit(word, context);
        }
    });

    document.getElementById('contextHintBtn').addEventListener('click', () => {
        document.getElementById('contextBlank').textContent = word.arabic;
        document.getElementById('contextHintBtn').disabled = true;
    });

    document.getElementById('contextSubmitBtn').addEventListener('click', () => {
        handleContextSubmit(word, context);
    });
}

function handleContextSubmit(word, context) {
    const input = document.getElementById('contextInput');
    const userAnswer = input.value.trim();
    const correctAnswer = word.arabic;

    // Normalize Arabic text for comparison
    const normalizedUser = normalizeArabic(userAnswer);
    const normalizedCorrect = normalizeArabic(correctAnswer);

    const isCorrect = normalizedUser === normalizedCorrect;

    const session = state.currentSession;

    input.disabled = true;
    document.getElementById('contextHintBtn').disabled = true;
    document.getElementById('contextSubmitBtn').disabled = true;

    const blank = document.getElementById('contextBlank');
    blank.textContent = correctAnswer;

    if (isCorrect) {
        input.classList.add('correct');
        blank.style.borderColor = '#2ecc71';
        blank.style.color = '#2ecc71';
        session.correct++;
        session.points += 15;
    } else {
        input.classList.add('wrong');
        blank.style.borderColor = '#e74c3c';
        session.wrong++;
    }

    session.answers.push({
        word: word,
        correct: isCorrect,
        userAnswer: userAnswer
    });

    updateTrainingProgress();

    setTimeout(() => {
        session.currentIndex++;
        runContextDetective();
    }, 1500);
}

// ============================================
// RESULTS & PROGRESS
// ============================================
function updateTrainingProgress() {
    const session = state.currentSession;
    const current = session.currentIndex + 1;
    const total = session.words.length;

    document.getElementById('currentWord').textContent = Math.min(current, total);
    document.getElementById('correctCount').textContent = session.correct;
    document.getElementById('wrongCount').textContent = session.wrong;
    document.getElementById('trainingProgressFill').style.width =
        (session.currentIndex / total * 100) + '%';
}

function showResults() {
    clearInterval(speedTimer);

    const session = state.currentSession;
    const total = session.answers.length || session.words.length;
    const percentage = total > 0 ? Math.round((session.correct / total) * 100) : 0;

    // Update global progress
    state.progress.totalPoints += session.points;

    // Update streak
    const today = new Date().toDateString();
    if (state.progress.lastPractice !== today) {
        state.progress.streak++;
        state.progress.lastPractice = today;
    }

    // Update module progress
    state.selectedModules.forEach(moduleKey => {
        const moduleWords = ARB202_VOCABULARY[moduleKey].words;
        const answeredFromModule = session.answers.filter(a =>
            moduleWords.some(w => w.id === a.word.id)
        );
        const correctFromModule = answeredFromModule.filter(a => a.correct).length;
        const currentProgress = state.progress.moduleProgress[moduleKey] || 0;
        const newProgress = Math.min(100, currentProgress + (correctFromModule * 2));
        state.progress.moduleProgress[moduleKey] = newProgress;
    });

    // Add mastered words
    session.answers.filter(a => a.correct).forEach(a => {
        if (!state.progress.masteredWords.includes(a.word.id)) {
            state.progress.masteredWords.push(a.word.id);
        }
    });

    saveProgress();
    updateStatsDisplay();

    // Show results screen
    document.getElementById('resultsScore').textContent = percentage + '%';
    document.getElementById('resultsLabel').textContent = getResultsLabel(percentage);
    document.getElementById('resultsCorrect').textContent = session.correct;
    document.getElementById('resultsWrong').textContent = session.wrong;
    document.getElementById('resultsPoints').textContent = '+' + session.points;

    // Render breakdown
    const breakdown = document.getElementById('resultsBreakdown');
    breakdown.innerHTML = '<h3>Word Breakdown</h3>' +
        session.answers.map(a => `
            <div class="breakdown-item">
                <div class="breakdown-word">
                    <span class="arabic">${a.word.arabic}</span>
                    <span>-</span>
                    <span>${a.word.english}</span>
                </div>
                <div class="breakdown-status">${a.correct ? '‚úì' : '‚úó'}</div>
            </div>
        `).join('');

    showScreen('resultsScreen');

    // Check for achievements
    checkAchievements(percentage);

    // Re-render module grid with updated progress
    renderModuleGrid();
}

function getResultsLabel(percentage) {
    if (percentage >= 100) return 'Perfect! Amazing!';
    if (percentage >= 80) return 'Great job!';
    if (percentage >= 60) return 'Good progress!';
    if (percentage >= 40) return 'Keep practicing!';
    return 'Don\'t give up!';
}

function checkAchievements(percentage) {
    // First session achievement
    const sessionsCompleted = parseInt(localStorage.getItem('sessions_completed') || '0');
    if (sessionsCompleted === 0) {
        showAchievement('üéâ', 'First Steps!', 'You completed your first training session!');
    }
    localStorage.setItem('sessions_completed', sessionsCompleted + 1);

    // Perfect score
    if (percentage === 100) {
        showAchievement('‚≠ê', 'Perfect Score!', 'You got every word right!');
    }

    // Streak achievements
    if (state.progress.streak === 7) {
        showAchievement('üî•', 'Week Warrior!', '7 day learning streak!');
    }
}

function showAchievement(icon, title, desc) {
    document.getElementById('achievementIcon').textContent = icon;
    document.getElementById('achievementTitle').textContent = title;
    document.getElementById('achievementDesc').textContent = desc;
    document.getElementById('overlay').classList.add('show');
    document.getElementById('achievementPopup').classList.add('show');

    setTimeout(closeAchievement, 3000);
}

function closeAchievement() {
    document.getElementById('overlay').classList.remove('show');
    document.getElementById('achievementPopup').classList.remove('show');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function getDirection() {
    if (state.selectedDirection === 'mixed') {
        return Math.random() > 0.5 ? 'ar-en' : 'en-ar';
    }
    return state.selectedDirection;
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function levenshteinDistance(str1, str2) {
    const m = str1.length;
    const n = str2.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));

    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;

    for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
            if (str1[i - 1] === str2[j - 1]) {
                dp[i][j] = dp[i - 1][j - 1];
            } else {
                dp[i][j] = 1 + Math.min(dp[i - 1][j], dp[i][j - 1], dp[i - 1][j - 1]);
            }
        }
    }
    return dp[m][n];
}

function normalizeArabic(text) {
    return text
        .replace(/[\u064B-\u065F]/g, '') // Remove tashkeel
        .replace(/\s+/g, ' ')
        .trim();
}

// Initialize
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
